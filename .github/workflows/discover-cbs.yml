name: Discover CBS Publications

on:
  schedule:
    - cron: '30 23 * * *'  # 23:30 UTC daily, before Worker's midnight cron
  workflow_dispatch: {}     # Allow manual trigger

jobs:
  discover:
    runs-on: ubuntu-latest
    env:
      CBS_BASE: https://www.cbs.gov.il
      PUB_LIST_GUID: 71b30cd4-0261-4757-9482-a52c5a6da90a
      MEDIA_LIST_GUID: db8f0177-370a-46ec-9ab9-041b54247975
    steps:
      - name: Discover CBS publications and media releases
        id: discover
        run: |
          set -euo pipefail

          SP_HEADERS='-H "Accept: application/json;odata=nometadata" -H "X-Requested-With: XMLHttpRequest"'
          MANIFEST='[]'
          CURRENT_YEAR=$(date +%Y)

          # Helper: enumerate files in a DocLib folder and add to manifest
          enumerate_files() {
            local SECTION="$1"  # publications or mediarelease
            local SOURCE="$2"   # cbs-publications or cbs-media
            local YEAR="$3"
            local FOLDER="$4"
            local TITLE="$5"
            local TITLE_EN="$6"
            local PUB_DATE="$7"

            local FILES_URL="${CBS_BASE}/he/${SECTION}/Madad/_api/web/GetFolderByServerRelativeUrl('/he/${SECTION}/Madad/DocLib/${YEAR}/${FOLDER}')/Files"

            local FILES_RESPONSE
            FILES_RESPONSE=$(curl -sf \
              -H "Accept: application/json;odata=nometadata" \
              -H "X-Requested-With: XMLHttpRequest" \
              "$FILES_URL" 2>/dev/null) || return 0

            local FILE_COUNT
            FILE_COUNT=$(echo "$FILES_RESPONSE" | jq '.value // [] | length')

            if [ "$FILE_COUNT" -eq 0 ]; then
              return 0
            fi

            echo "    Found $FILE_COUNT files in $FOLDER"

            for j in $(seq 0 $((FILE_COUNT - 1))); do
              local FILE FILENAME SERVER_URL FILE_SIZE EXT
              FILE=$(echo "$FILES_RESPONSE" | jq ".value[$j]")
              FILENAME=$(echo "$FILE" | jq -r '.Name')
              SERVER_URL=$(echo "$FILE" | jq -r '.ServerRelativeUrl')
              FILE_SIZE=$(echo "$FILE" | jq -r '.Length // "0"')
              EXT=$(echo "$FILENAME" | rev | cut -d. -f1 | rev | tr '[:upper:]' '[:lower:]')

              case "$EXT" in
                xlsx|xls|docx|doc|pdf|zip) ;;
                *) continue ;;
              esac

              local PUB_ID="${SOURCE/cbs-/cbs-}-${YEAR}-${FOLDER}"
              if [ "$SOURCE" = "cbs-publications" ]; then
                PUB_ID="cbs-pub-${YEAR}-${FOLDER}"
              fi

              local ENTRY
              ENTRY=$(jq -n \
                --arg source "$SOURCE" \
                --arg url "${CBS_BASE}${SERVER_URL}" \
                --arg filename "$FILENAME" \
                --arg format "$EXT" \
                --arg pub_id "$PUB_ID" \
                --arg pub_date "$PUB_DATE" \
                --arg title "$TITLE" \
                --arg title_en "$TITLE_EN" \
                --arg year "$YEAR" \
                --arg folder "$FOLDER" \
                --argjson size "${FILE_SIZE:-0}" \
                '{
                  source: $source,
                  url: $url,
                  filename: $filename,
                  format: $format,
                  publication_id: $pub_id,
                  publish_date: $pub_date,
                  metadata: { title: $title, title_en: $title_en, year: $year, folder: $folder, size: $size },
                  is_new: true
                }')

              MANIFEST=$(echo "$MANIFEST" | jq ". + [$ENTRY]")
            done
          }

          ###############################################
          # CBS Media Releases — enumerate DocLib folders
          # DocLib uses numeric IDs (050, 051...) not page slugs
          ###############################################
          echo "=== Discovering CBS media releases ==="

          # Get the list of page items to map titles/dates
          MEDIA_URL="${CBS_BASE}/he/mediarelease/Madad/_api/Web/Lists(guid'${MEDIA_LIST_GUID}')/items?\$orderby=Created%20desc&\$top=15&\$select=Id,Title,CbsEnglishTitle,ArticleStartDate,Created,FileRef"
          MEDIA_RESPONSE=$(curl -sf \
            -H "Accept: application/json;odata=nometadata" \
            -H "X-Requested-With: XMLHttpRequest" \
            "$MEDIA_URL") || { echo "::warning::CBS media list API failed, skipping"; MEDIA_RESPONSE='{"value":[]}'; }

          if echo "$MEDIA_RESPONSE" | head -c 1 | grep -q '<'; then
            echo "::warning::CBS media list API returned HTML, skipping"
            MEDIA_RESPONSE='{"value":[]}'
          fi

          # Enumerate DocLib subfolders for current year
          echo "  Listing DocLib/$CURRENT_YEAR subfolders..."
          MEDIA_FOLDERS_URL="${CBS_BASE}/he/mediarelease/Madad/_api/web/GetFolderByServerRelativeUrl('/he/mediarelease/Madad/DocLib/${CURRENT_YEAR}')/Folders"
          MEDIA_FOLDERS=$(curl -sf \
            -H "Accept: application/json;odata=nometadata" \
            -H "X-Requested-With: XMLHttpRequest" \
            "$MEDIA_FOLDERS_URL" 2>/dev/null) || { echo "::warning::Could not list media DocLib folders"; MEDIA_FOLDERS='{"value":[]}'; }

          FOLDER_COUNT=$(echo "$MEDIA_FOLDERS" | jq '.value // [] | length')
          echo "  Found $FOLDER_COUNT DocLib folders"

          for i in $(seq 0 $((FOLDER_COUNT - 1))); do
            FOLDER_NAME=$(echo "$MEDIA_FOLDERS" | jq -r ".value[$i].Name")

            # Try to find matching page item for title/date metadata
            # The page item's FileRef doesn't match the DocLib folder name,
            # so we use the first available title as a fallback
            TITLE=$(echo "$MEDIA_RESPONSE" | jq -r ".value[0].Title // \"CBS Media Release $FOLDER_NAME\"")
            TITLE_EN=$(echo "$MEDIA_RESPONSE" | jq -r ".value[0].CbsEnglishTitle // \"\"")
            PUB_DATE=$(echo "$MEDIA_RESPONSE" | jq -r ".value[0].ArticleStartDate // .value[0].Created // \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"")

            enumerate_files "mediarelease" "cbs-media" "$CURRENT_YEAR" "$FOLDER_NAME" "$TITLE" "$TITLE_EN" "$PUB_DATE"
          done

          ###############################################
          # CBS Publications — enumerate DocLib folders
          ###############################################
          echo ""
          echo "=== Discovering CBS publications ==="

          PUB_URL="${CBS_BASE}/he/publications/Madad/_api/Web/Lists(guid'${PUB_LIST_GUID}')/items?\$orderby=Created%20desc&\$top=20&\$select=Id,Title,CbsEnglishTitle,ArticleStartDate,Created,FileRef"
          PUB_RESPONSE=$(curl -sf \
            -H "Accept: application/json;odata=nometadata" \
            -H "X-Requested-With: XMLHttpRequest" \
            "$PUB_URL") || { echo "::warning::CBS publications list API failed, skipping"; PUB_RESPONSE='{"value":[]}'; }

          if echo "$PUB_RESPONSE" | head -c 1 | grep -q '<'; then
            echo "::warning::CBS publications list API returned HTML, skipping"
            PUB_RESPONSE='{"value":[]}'
          fi

          # Enumerate DocLib subfolders for current year
          echo "  Listing DocLib/$CURRENT_YEAR subfolders..."
          PUB_FOLDERS_URL="${CBS_BASE}/he/publications/Madad/_api/web/GetFolderByServerRelativeUrl('/he/publications/Madad/DocLib/${CURRENT_YEAR}')/Folders"
          PUB_FOLDERS=$(curl -sf \
            -H "Accept: application/json;odata=nometadata" \
            -H "X-Requested-With: XMLHttpRequest" \
            "$PUB_FOLDERS_URL" 2>/dev/null) || { echo "  No publication DocLib folders found for $CURRENT_YEAR"; PUB_FOLDERS='{"value":[]}'; }

          PUB_FOLDER_COUNT=$(echo "$PUB_FOLDERS" | jq '.value // [] | length')
          echo "  Found $PUB_FOLDER_COUNT DocLib folders"

          for i in $(seq 0 $((PUB_FOLDER_COUNT - 1))); do
            FOLDER_NAME=$(echo "$PUB_FOLDERS" | jq -r ".value[$i].Name")

            TITLE=$(echo "$PUB_RESPONSE" | jq -r ".value[0].Title // \"CBS Publication $FOLDER_NAME\"")
            TITLE_EN=$(echo "$PUB_RESPONSE" | jq -r ".value[0].CbsEnglishTitle // \"\"")
            PUB_DATE=$(echo "$PUB_RESPONSE" | jq -r ".value[0].ArticleStartDate // .value[0].Created // \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"")

            enumerate_files "publications" "cbs-publications" "$CURRENT_YEAR" "$FOLDER_NAME" "$TITLE" "$TITLE_EN" "$PUB_DATE"
          done

          ###############################################
          # Summary and output
          ###############################################
          TOTAL=$(echo "$MANIFEST" | jq 'length')
          echo ""
          echo "=== Discovery complete: $TOTAL manifest entries ==="

          if [ "$TOTAL" -gt 0 ]; then
            echo "$MANIFEST" | jq '[.[] | {source, filename, publication_id}]'
          fi

          echo "$MANIFEST" > /tmp/manifest.json
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"

      - name: Post manifest to Worker
        if: steps.discover.outputs.total != '0'
        env:
          INGEST_WEBHOOK_URL: ${{ secrets.INGEST_WEBHOOK_URL }}
          INGEST_AUTH_TOKEN: ${{ secrets.INGEST_AUTH_TOKEN }}
        run: |
          set -euo pipefail

          TOTAL=$(jq 'length' /tmp/manifest.json)
          echo "Posting $TOTAL manifest entries to Worker in batches..."

          # Send in batches of 10 to avoid Worker timeouts
          BATCH_SIZE=10
          BATCH_NUM=0
          TOTAL_PROCESSED=0
          TOTAL_ERRORS=0

          for OFFSET in $(seq 0 $BATCH_SIZE $((TOTAL - 1))); do
            BATCH_NUM=$((BATCH_NUM + 1))
            BATCH_END=$((OFFSET + BATCH_SIZE))
            if [ "$BATCH_END" -gt "$TOTAL" ]; then
              BATCH_END=$TOTAL
            fi

            echo "  Batch $BATCH_NUM: entries $OFFSET-$((BATCH_END - 1))"

            jq "{entries: .[$OFFSET:$BATCH_END]}" /tmp/manifest.json > /tmp/payload.json

            RESPONSE=$(curl -sf -w "\n%{http_code}" \
              -X POST "${INGEST_WEBHOOK_URL}/api/manifest" \
              -H "Authorization: Bearer ${INGEST_AUTH_TOKEN}" \
              -H "Content-Type: application/json" \
              -d @/tmp/payload.json) || {
              echo "::warning::Batch $BATCH_NUM failed"
              TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
              sleep 2
              continue
            }

            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            echo "    Response (HTTP $HTTP_CODE): $BODY"

            BATCH_PROCESSED=$(echo "$BODY" | jq -r '.processed // 0')
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + BATCH_PROCESSED))

            # Rate limit: wait between batches
            sleep 2
          done

          echo ""
          echo "=== Done: $TOTAL_PROCESSED files processed, $TOTAL_ERRORS batch errors ==="

      - name: No new files
        if: steps.discover.outputs.total == '0'
        run: echo "No new CBS files discovered"
